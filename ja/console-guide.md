## Storage > NAS > コンソール使用ガイド

### ストレージの作成

新しいストレージを作成します。作成されたストレージはNFS(network file system、ネットワークファイルシステム)及びCIFS(common internet file system、共用インターネットファイルシステム)プロトコルを利用してインスタンスからアクセスできます。

| 項目 | 説明 |
| -- | -- |
| 名前 | 作成するストレージの名前です。ストレージ名を利用してNFSまたはCIFSのアクセスパスを作成します。名前は100文字以内の英字と数字、一部記号('-', '_')のみ入力できます。 |
| 説明 | ストレージの説明です。 |
| サイズ | 作成するストレージのサイズです。最小300GBから最大10,000GBまで入力できます。 |
| プロトコル | ストレージにアクセスするプロトコルを選択します。CIFSとNFSをサポートし、同時に使用することはできません。 |
| VPC | ストレージにアクセスするVPC(virtual private cloud、仮想プライベートクラウド)です。 |
| サブネット | ストレージにアクセスするサブネットです。選択されたVPCのサブネットのみ選択できます。 |
| アクセス制御リスト(ACL) | 読み取り、書き込み権限を許可するIPまたはIP帯域リストです。 |
| スナップショット自動作成 | 毎日1回指定された時間に自動的に作成します。最大保存数に達すると、作成されたスナップショットのうち、最も古いスナップショットが自動的に削除されます。  |
| スナップショット予約容量 | スナップショットが保存されるスペースを事前に割り当てます。設定した容量以外の容量でデータ保存が可能です。0を入力した場合、スナップショットが正常に作成されません。 |
| 暗号化 | ストレージ暗号化を使用するかどうかを選択します。暗号化キーストア設定が 先に行われなければなりません。 |

> [参考]
> 2024年2月現在、プロジェクトごとに使用可能なサブネットは合計3つに制限されます。サブネット数の限度を増やす場合はサポートにお問い合わせください。

#### CIFS認証情報の管理
CIFSプロトコルを使用するためには、CIFS認証情報を作成する必要があります。認証情報はプロジェクト単位で管理され、CIFSストレージごとにアクセスするCIFS認証情報を登録する必要があります。


#### 暗号化キーストア設定

NAS暗号化ストレージは、暗号化に使用する対称鍵をNHN Cloud Secure Key Managerサービスのキーストアに保存します。したがって、暗号化ストレージを作成するためには、事前にSecure Key Managerサービスで[キーストアを作成](https://docs.nhncloud.com/ja/Security/Secure%20Key%20Manager/ja/getting-started/#_1)する必要があります。 [キーストアのIDを確認](https://docs.nhncloud.com/ja/Security/Secure%20Key%20Manager/ja/getting-started/#_2)して暗号化キーストア設定に入力します。

暗号化ストレージを作成すると、設定したキーストアに対称鍵が保存されます。NASサービスによってキーストアに保存された対称鍵は暗号化ストレージの使用中は削除できません。暗号化ストレージを削除すると、対称鍵も一緒に削除されます。

キーストアIDを変更すると、その後作成する暗号化ストレージの対称鍵が変更されたキーストアに保存されます。既存キーストアに保存された対称鍵は維持されます。

> [参考]
> Secure Key Managerサービス料金ポリシーに基づいてキーストア使用料金が請求されます。利用料金の詳細については、 [Secure Key Manager料金案内](https://www.nhncloud.com/kr/service/security/secure-key-manager#price)を参照してください。
>
> NAS暗号化ストレージは、XTS-AES-256アルゴリズムで異なる2つの対称鍵を使用してデータを暗号化します。 したがって、暗号化ストレージごとに2つの対称鍵をキーストレージに保存します。

### ストレージサイズ変更

NASストレージのサイズを変更します。ストレージの使用中にも拡張および縮小が可能です。

### アクセス制御リスト設定の変更

ストレージのアクセス制御リスト(ACL)設定を変更します。

### スナップショット設定の変更

スナップショット自動作成およびスナップショット予約容量の設定を変更します。

### ストレージ削除

NASストレージを削除します。

> [注意]
> 接続されたインスタンスからマウント解除後、削除することを推奨します。マウント状態でストレージを削除すると、ユーザーシステムに問題が発生する可能性があります。
>
> ストレージを削除すると、スナップショットを含むすべてのデータが削除されます。削除後にはデータを復元できません。

### スナップショット
作成されたスナップショットリストを照会します。

| 項目 | 説明 |
| --- | --- |
| 名前 | スナップショットの名前を表示します。システムによって作成された場合、指定されたルールに従って名前が決定されます。 |
| スナップショット作成時のストレージ使用量 | スナップショット作成時のNASストレージ使用量です。スナップショットを復元する場合、そのサイズで復元されます。 |
| 作成日｜スナップショットが作成された日時です。 |


#### スナップショット作成

NASストレージのスナップショットをすぐに作成します。

#### スナップショット復元
ストレージをスナップショットが作成された時点に復元します。

> [注意]
> 復元すると、復元時点以降に作成されたスナップショットは自動的に削除されます。

#### スナップショット復元結果照会
ストレージを復元した履歴を照会します。

#### スナップショット削除

指定されたスナップショットを削除します。一度削除されたスナップショットは復元できません。

### ネットワーク
ネットワーク接続情報を確認します。

| 項目 | 説明 |
| --- | --- |
| 接続情報 | インスタンスでマウント時に使用する接続経路を表示します。 |
| サブネット | ストレージと接続されているサブネット情報です。 |
| 状態 | サブネット接続状態を表示します。 |


#### サブネット接続追加
サブネット接続を追加します。サブネット接続を追加すると、追加されたサブネットからNASストレージにアクセスできます。

> [注意]
> サブネット接続を追加した後、ACLにサブネット帯域が存在しない場合、マウントはできません。
#### サブネット接続解除
ストレージに接続されたサブネットを削除します。必要な場合、IP ACLは別途削除する必要があります。

> [注意]
> 接続されたインスタンスでマウントを解除した後、サブネット接続を解除することを推奨します。マウント状態で接続を解除すると、ユーザーシステムに問題が発生する可能性があります。

### モニタリング

NASストレージの複数の指標をグラフで確認します。確認したいストレージを選択した後、 **モニタリング**タブを選択します。

基本的な照会期間は最後の1時間で、照会期間フィルタで特定の期間を照会できます。モニタリング指標の説明は以下の表で確認できます。

| 指標 | 単位 | 説明 |
| --- | --- | --- |
| ストレージ容量 | byte | ストレージの総容量と使用中の容量を表示します。 |
| ストレージ使用率 | % | ストレージの総容量に対する使用中の容量をパーセンテージで表示します。 |
| IOPS | OPS | ストレージの毎秒の演算数を表示します。 |
| Latency | usec | ストレージの遅延時間を表示します。 |
| スナップショット数 | - | ストレージのスナップショット数を表示します。 |
| スナップショット容量 | byte | ストレージがスナップショットに使用している容量を表示します。 |
| Inode | - | ストレージのinode数を表示します。 |
| ストレージ状態 | - | ストレージの状態を表示します。 |
| クライアント接続数 | - | ストレージに接続されたクライアント数を表示します。 |

### 複製

複製設定関連情報を確認します。

| 設定 | 説明 |
| --- | --- |
| 複製設定 | ストレージの複製設定を表示します。 |
| 複製設定状態 | 原本と対象ストレージ間の複製設定状態を表示します。<br>Active:有効化状態<br>Retrieve failed:一時的な情報取得失敗<br>Halt:一時停止状態<br>最初の複製進行状態では、複製進行率と対象ストレージの暗号化状態を追加で表示します。 |
| 最近の複製実行結果 | 最近実行した複製結果を表示します。 |
| 最近の複製実行時間 | 最近複製を実行した時間を表示します。 |
| 最近の複製成功時間 | 最近複製を完了した時間を表示します。 |
| 複製方向 | 複製方向を表示します。 |
| 対象リージョン | 複製対象リージョンを表示します。複製を設定した原本ストレージの場合にのみ表示されます。 |
| 対象ストレージ | 複製対象ストレージ名を表示します。複製を設定した原本ストレージの場合にのみ表示されます。|
| 原本リージョン | 複製原本リージョンを表示します。複製が設定された対象ストレージの場合にのみ表示されます。|
| 原本ストレージ | 複製原本ストレージ名を表示します。複製が設定された対象ストレージの場合にのみ表示されます。 |

#### 複製設定

組織内のプロジェクトの選択したリージョンに複製を設定できます。
複製を設定すると、対象位置に原本ストレージと同じサイズの対象ストレージが作成されます。対象ストレージは読み取り専用状態で作成され、対象ストレージの状態を変更するには複製を停止するか、複製設定を解除する必要があります。
ソースストレージのデータを更新または削除すると、ターゲットストレージのデータも更新または削除されます。

対象プロジェクトごとに選択可能なリージョンの範囲は下表で確認できます。

| 対象プロジェクト | 選択可能なリージョン |
| -- | -- |
| 組織内の同一プロジェクト | 別のリージョン |
| 組織内の他のプロジェクト | 全てのリージョン |

> [注意]
> 複製設定されたストレージのサイズを変更するには、ソースストレージとターゲットストレージの両方を変更する必要があります。ソースストレージとターゲットストレージのサイズが異なる場合、複製に失敗する可能性があります。
> [参考]
> 複製設定で作成されたターゲットストレージは、NASサービス料金ポリシーに基づいてストレージ容量料金が請求されます。
>
> 複製により発生するネットワークトラフィックに対して、他のリージョン間トラフィック料金が請求されます。
>
> > 利用料金に関する詳細は、[NAS料金案内](https://www.nhncloud.com/kr/service/storage/nas)を参照してください。
#### 複製開始

停止状態のストレージの複製を再開します。
元のストレージに変更が発生すると、非同期的に複製が実行されます。複製が実行される前は、ソースストレージとターゲットストレージのデータが一致しない場合があります。

> [注意]
> ターゲットストレージのサイズがソースストレージのサイズより小さい場合、複製に失敗する可能性があります。
>
> 複製が実行されると、ターゲットストレージの既存データはすべて削除され、ソースストレージの形状と同じ状態で適用されます。
#### 複製停止

ストレージ複製を停止します。
複製を停止すると、ターゲットストレージが書き込み可能な状態に変更され、マウントして使用できます。

> [注意]
> 複製を停止すると、ソースストレージとターゲットストレージのデータが一致しない場合があります。
> [参考]
> 複製停止状態のストレージも、複製状態を確認するため、少量のトラフィックが発生する場合があります。
#### 複製方向の変更

ソースストレージとターゲットストレージの複製方向を変更します。

* **[ソース→ターゲット]**から**[ターゲット→ソース]**に複製方向を変更します。
    * ソースストレージの既存データはすべて削除され、ターゲットストレージのデータをソースストレージに複製します。
    * ターゲットストレージのサイズよりソースストレージのサイズが小さい場合、複製に失敗する可能性があります。

* **[ターゲット→ソース]**から **[ソース→ターゲット]**に複製方向を変更(原状復帰)
    * ターゲットストレージの既存データはすべて削除され、ソースストレージのデータをターゲットストレージに複製します。
    * ソースストレージサイズよりターゲットストレージサイズが小さい場合、複製に失敗する可能性があります。

#### 複製設定の解除

ストレージの複製設定を解除します。
複製設定を解除すると、ターゲットストレージは、最後の複製完了時点のソースストレージデータをそのまま保持します。

> [注意]
> 複製を再設定すると、新しいターゲットストレージが作成されます。以前使用していたターゲットストレージを再び複製対象ストレージとして使用することはできません。

### ストレージ接続

作成されたストレージの接続情報を利用してインスタンスにマウントできます。ただし、マウントするインスタンスはストレージと同じサブネットに接続されている必要があります。

#### NFS

##### nfsパッケージのインストール

* Debian, Ubuntu: nfs-common, rpcbind
  ```
  sudo apt-get install nfs-common rpcbind
  ```
* CentOS: nfs-utils, rpcbind
  ```
  sudo yum install nfs-utils rpcbind
  ```

##### rpcbindサービス実行

```
sudo service rpcbind start
```

##### NASストレージマウント

```
sudo mount -t nfs {nas source} {mount point}
```

* nas source: NASストレージ情報
 例：192.168.0.241:/data
* mount point: NASストレージをマウントするディレクトリ
 例：/mnt

#### CIFS

ファイルエクスプローラーの左側のナビゲーションウィンドウで**マイPC**を右クリックし、**ネットワークドライブ接続**を選択します。ネットワークドライブ接続ウィンドウが表示されたら、マウントするドライブを選択した後、フォルダパスを入力します。フォルダパス形式は`\\{ストレージip}\{ストレージ名}`です。例：\\\\192.168.0.100\\cifs

